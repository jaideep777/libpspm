<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="libpspm">
<title>Defining a PSPM - additional features • libpspm</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Defining a PSPM - additional features">
<meta property="og:description" content="libpspm">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">libpspm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
    Home
  </a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--tutorials">
    <span class="fa fa-book fa-lg"></span>
     
    Tutorials
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--tutorials">
    <a class="dropdown-item" href="../articles/what_is_pspm.html">What is a PSPM?</a>
    <a class="dropdown-item" href="../articles/defining_model_basic.html">Setting up your PSPM</a>
    <a class="dropdown-item" href="../articles/size_integral.html">Computing state integrals</a>
    <a class="dropdown-item" href="../articles/demo_red.html">Demo: RED model</a>
    <a class="dropdown-item" href="../articles/defining_model_advanced.html">Advanced usage</a>
    <a class="dropdown-item" href="../articles/demo_daphnia.html">Demo: Daphnia model</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown--developer">
    <span class="fa fa-user-secret"></span>
     
    Developer
  </a>
  <div class="dropdown-menu" aria-labelledby="dropdown--developer">
    <a class="dropdown-item" href="../articles/size_integral_dev.html">Size integrals</a>
    <a class="dropdown-item" href="../articles/ode_flow_dev.html">Logic flowchart</a>
    <a class="dropdown-item" href="../articles/faq_dev.html">FAQs for developers</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../html/index.html">
    <span class="fa fa-code fa-lg"></span>
     
    API
  </a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../articles/news.html">
    <span class="fa fa-newspaper fa-lg"></span>
     
    News
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jaideep777/libpspm">
    <span class="fa fa-github fa-lg"></span>
     
    GitHub
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Defining a PSPM - additional features</h1>
                        <h4 data-toc-skip class="author">Jaideep
Joshi</h4>
            
            <h4 data-toc-skip class="date">11 March 2022</h4>
      
      
      <div class="d-none name"><code>defining_model_advanced.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="advanced-features">Advanced features<a class="anchor" aria-label="anchor" href="#advanced-features"></a>
</h2>
<p>So far, we have used only the most basic features of libpspm, where
we specified the three demographic rates, the environment conmputation,
and the initial condition. In this tutorial, we will see how additional
features can be specified in the model definition.</p>
<div class="section level3">
<h3 id="defining-a-custom-establishment-probability-function">Defining a custom establishment probability function<a class="anchor" aria-label="anchor" href="#defining-a-custom-establishment-probability-function"></a>
</h3>
<p>The PSPM Solver calls the Individual’s
<code>establishmentProbability</code> function to convert offspring
(e.g., eggs, seeds, and newborns) to juvenile individuals which survive
the infant phase and establish as recruits in the population. Recruits
are assumed to enter the population at i-state <span class="math inline">\(x_b\)</span>. For example, in a forest census, we
wish to monitor trees above 1 cm diameter, so <span class="math inline">\(x_b=1\)</span>. However, when seeds germinate, the
seedlings can be as small as 1 mm in diameter and far more numerous in
size. Furthermore, not all seeds germinate successfully. Thus, the
survival of seeds (prior to germination) and the survival of seedlings
up to the recruitment size of 1 cm can be specified by the
<code>establishmentProbability</code> function. This survival
probability can also depend on the Environment. To do so, define the
function in the individual class as follows:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> establishmentProbability<span class="op">(</span><span class="dt">double</span> t<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span> env<span class="op">){</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">0.1</span><span class="op">;</span> <span class="co">// say, the establishment probability is 10%</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="customizing-setsize-to-set-multiple-size-dependent-variables">Customizing setSize() to set multiple size-dependent variables<a class="anchor" aria-label="anchor" href="#customizing-setsize-to-set-multiple-size-dependent-variables"></a>
</h3>
<p>When the state of an individual changes, many other physiological
variables may undergo a determinate scaling. For example, when a tree
grows and its diamater increases, its height and crown area also
increase. It may be convenient to keep track of these changes through
internal variables, rather than computing them on the fly every time
they are needed. To update such variables every time when the i-state is
updated, override the <code>setSize</code> function from
<code>IndividualBase</code>. This function should take the (updated)
i-state <span class="math inline">\(x\)</span> as input, and set all
necessary internal variables accordingly, as follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> set_size<span class="op">(</span><span class="dt">double</span> _x<span class="op">){</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  diameter <span class="op">=</span> x<span class="op">;</span>  <span class="co">// suppose i-state is diamater, which is an internal variable</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  crown_area <span class="op">=</span> a<span class="op">*</span>pow<span class="op">(</span>diameter<span class="op">,</span> b<span class="op">);</span>  <span class="co">// update crown area based on diameter</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-precomputations-for-calculating-demographic-rates">Using precomputations for calculating demographic rates<a class="anchor" aria-label="anchor" href="#using-precomputations-for-calculating-demographic-rates"></a>
</h3>
<p>Often, the computation of the demographic rates depends on a common
variable which is expensive to compute. For example, the growth,
mortality, and fecundity rates of trees may all depend on the their
carbon uptake rate, which may be expensive to calculate. It would be
expensive and redundant to do such a computation on the fly in each rate
function. Instead, you can override the <code>precompute</code> function
from <code>IndividualBase</code> to do such computations and store the
result in a member variable. The rate functions can then make use of the
stored variables. This way, the expensive computation is done only once,
rather than 3 times.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyIndividual <span class="op">:</span> <span class="kw">public</span> IndividualBase<span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> result<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> preCompute<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> t<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span> env<span class="op">){</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> expensive_function<span class="op">(</span>x<span class="op">,</span>t<span class="op">,</span>env<span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> growthRate<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> t<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span> env<span class="op">){</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cheap_function_1<span class="op">(</span>result<span class="op">);</span>    </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> mortalityRate<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> t<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span> env<span class="op">){</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cheap_function_2<span class="op">(</span>result<span class="op">);</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> birthRate<span class="op">(</span><span class="dt">double</span> x<span class="op">,</span> <span class="dt">double</span> t<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span> env<span class="op">){</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cheap_function_3<span class="op">(</span>result<span class="op">);</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other functions.... </span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="customizing-printing-of-i-state">Customizing printing of i-state<a class="anchor" aria-label="anchor" href="#customizing-printing-of-i-state"></a>
</h3>
<p>The default behaviour when a cohort is printed is to only print the
birth time, i-state and density. Often, it is convenient to view these
properties in the context of other properties of the individual, such as
individual-specific traits. To do so, you can override the
<code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> function:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyIndividual <span class="op">:</span> <span class="kw">public</span> IndividualBase<span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">void</span> print<span class="op">(</span><span class="bu">std::</span>ostream<span class="op"> &amp;</span>out<span class="op">){</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    out <span class="op">&lt;&lt;</span> <span class="st">"|"</span> <span class="op">&lt;&lt;</span> lma <span class="op">&lt;&lt;</span> <span class="st">"</span><span class="sc">\t</span><span class="st">"</span> <span class="op">&lt;&lt;</span> crown_area<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other functions...</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>This will output the <code>lma</code> and <code>crown_area</code> of
the <code>MyIndividual</code> after the default cohort properties, like
so:</p>
<pre><code>  1.0    20    0.1  |  0.19    26 </code></pre>
</div>
<div class="section level3">
<h3 id="defining-s-state-variables">Defining s-state variables<a class="anchor" aria-label="anchor" href="#defining-s-state-variables"></a>
</h3>
<p>System state variables which are simulated by ODEs can be defined.
For example, if you want to simulate a renewable resource <span class="math inline">\(R\)</span> which follows logistic growth dynamics
with a harvesting rate <span class="math inline">\(h\)</span> that is
dependent on the population structure and the environment,</p>
<p><span class="math display">\[
dR/dt = rR(1-R/K) - h(X,t,E).
\]</span></p>
<p>Such a variable can be simulated by adding a system state variable
(s-state variable) to the Solver.</p>
<p>To add a system variable, use the function</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Assuming a solver object 'S' has been created</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> n <span class="op">=</span> <span class="dv">1</span><span class="op">;</span>                <span class="co">// the number of system variables to add</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>S<span class="op">.</span>addSystemVariables<span class="op">(</span>n<span class="op">);</span>  <span class="co">// this can be done either before or after addSpecies()</span></span></code></pre></div>
<p>System variables are always inserted at the beginning of the state
vector. Thus, if <span class="math inline">\(n\)</span> s-state
variables have been created, they can be accessed by
<code>state[0]</code> to <code>state[n-1]</code>.</p>
<p>The <code>computeEnv</code> function obtains the current
<code>state</code> and <code>rates</code> vectors from the
<code>Solver</code>. The rate computation for s-state variables should
be done in <code>computeEnv</code>, as follows.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyEnvironment <span class="op">:</span> <span class="kw">public</span> EnvironmentBase<span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">public</span><span class="op">:</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> state<span class="op">;</span> <span class="co">// a vector for storing the latest s-state variables</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> computeEnv<span class="op">(</span><span class="dt">double</span> t<span class="op">,</span> Solver <span class="op">*</span> sol<span class="op">,</span> vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator _S<span class="op">,</span> vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator _dSdt<span class="op">){</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>n<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> state<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">*</span>_S<span class="op">++;</span>  <span class="co">// get the s-state from the full state vector</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> rates <span class="op">=</span> <span class="op">...</span> <span class="co">// compute the rates corresponding to each s-state variable</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// copy the computed rates to the full rates vector  </span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span> r <span class="op">:</span> rates<span class="op">)</span> <span class="op">*</span>_dSdt<span class="op">++</span> <span class="op">=</span> r<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="defining-extra-i-state-variables---use-with-caution">Defining extra i-state variables - use with caution<a class="anchor" aria-label="anchor" href="#defining-extra-i-state-variables---use-with-caution"></a>
</h3>
<p>Sometimes, one may want to simulate state-variables which are
dependent on the i-state and the demographic history of the individual,
but need to be computed using ODEs together with the core state
variables. For example, the cumulative mortality of the individual is
the integral of the mortality rate over time, but this is not computed
by default. To enable the computation of such extra state variables, you
must do two steps. First, you must override the following four functions
in <code>IndividualBase</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyIndividual <span class="op">:</span> <span class="kw">public</span> IndividualBase<span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// main overrides...</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// here, we will define two extra state variables</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> init_state<span class="op">(</span><span class="dt">double</span> t<span class="op">,</span> <span class="dt">void</span> <span class="op">*</span> env<span class="op">){</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">// this function should set the initial condition for the extra state variables from time and environment</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator set_state<span class="op">(</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator <span class="op">&amp;</span>it<span class="op">){</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">// this function should update the extra state variables in the Individual from values starting at iterator it</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">// This must return the final (incremented) iterator, which will be cross checked to ensure that it was incremented as mny times as the number of extra state variables</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      extra_state1 <span class="op">=</span> <span class="op">*</span>it<span class="op">++;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>      extra_state2 <span class="op">=</span> <span class="op">*</span>it<span class="op">++;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> it<span class="op">;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator get_state<span class="op">(</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator <span class="op">&amp;</span>it<span class="op">){</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// this function should copy extra state variables from the Individual to the memory starting at iterator it</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>      <span class="co">// This must return the final (incremented) iterator, which will be cross checked to ensure that it was incremented as mny times as the number of extra state variables</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>it<span class="op">++</span> <span class="op">=</span> extra_state1<span class="op">;</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>it<span class="op">++</span> <span class="op">=</span> extra_state2<span class="op">;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> it<span class="op">;</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator get_rates<span class="op">(</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;::</span>iterator <span class="op">&amp;</span>it<span class="op">){</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// this function must compute the rates from the extra state variables that will be passed to the ODE solver</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">// These rates must be copied to the memory pouinted by `it`</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>it<span class="op">++</span> <span class="op">=</span> extra_rate1<span class="op">;</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      <span class="op">*</span>it<span class="op">++</span> <span class="op">=</span> extra_rate2<span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> it<span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>Second, to signal to the solver that the species should use extra
state variables, you should pass the number of extra state variables as
an argument to <code>addSpecies</code>, as follows:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>S<span class="op">.</span>addSpecies<span class="op">(</span><span class="dv">25</span><span class="op">,</span>     <span class="co">//  the (initial) number of cohorts to simulate</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>             <span class="dv">1</span><span class="op">,</span>      <span class="co">//  the i-state at birth</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>             <span class="fl">1e4</span><span class="op">,</span>    <span class="co">//  the maximum i-state value</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>             <span class="kw">false</span><span class="op">,</span>  <span class="co">//  whether the i-state axis should be on log scale</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>             <span class="op">&amp;</span>spp<span class="op">,</span>   <span class="co">//  a pointer to the species object </span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>             <span class="dv">2</span><span class="op">,</span>      <span class="co">//  *number of extra x-linked i-state variables*</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>             <span class="dv">1</span>       <span class="co">//  the input flux of newborns</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<div style="color: red;">
<p><strong>CAUTION</strong>: Note that this extra-state feature should
NOT be used to define i-state variables that are independent of the main
i-state variable. For example, if your individual is an animal who has a
2 dimensional i-state defined by, say, size and colour, then the two
i-state variables are independent of each other. In such a case these
functions should not be used to define colour as an extra state
variable. Multidimensional i-states are <strong>NOT</strong> currently
supported by libpspm.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://jaideep777.github.io" class="external-link">Jaideep
Joshi</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
